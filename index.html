<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>抽籤開始，祝你好運</title>
  <style>
    :root {
      --bg-1: #091226;
      --bg-2: #0b1633;
      --primary: #00ffd0;   /* 更明亮的主色 */
      --primary-2: #66b3ff; /* 輔助亮藍 */
      --accent: #ff66f5;    /* 亮粉紫 */
      --card: rgba(255,255,255,0.08);
      --card-border: rgba(255,255,255,0.16);
      --text: #f2f7ff;
      --muted: #a6b7e6;
      --danger: #ff6b6b;
      --chip-bg: rgba(255,255,255,0.12);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang TC", "Noto Sans TC", Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 800px at 10% 10%, #132257 0%, transparent 60%),
                  radial-gradient(1200px 800px at 90% 90%, #18255a 0%, transparent 60%),
                  linear-gradient(135deg, var(--bg-1), var(--bg-2));
      overflow-x: hidden;
    }
    .grid-overlay::before, .grid-overlay::after { content: ""; position: fixed; inset: 0; pointer-events: none; z-index: 0; }
    .grid-overlay::before {
      background-image: linear-gradient(rgba(255,255,255,0.09) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(255,255,255,0.09) 1px, transparent 1px);
      background-size: 40px 40px, 40px 40px; mix-blend-mode: overlay;
      mask-image: radial-gradient(circle at center, rgba(255,255,255,0.6), transparent 70%);
    }
    .grid-overlay::after { background: repeating-linear-gradient( to bottom, rgba(255,255,255,0.06) 0 2px, transparent 2px 6px ); animation: scan 6s linear infinite; }
    @keyframes scan { 0% { transform: translateY(-100vh); } 100% { transform: translateY(100vh);} }

    header { position: relative; z-index: 1; max-width: 1100px; margin: 32px auto 12px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; }
    .brand { font-size: 22px; letter-spacing: 0.04em; font-weight: 800; text-shadow: 0 0 10px rgba(0,255,208,0.7); }
    .brand .glow { color: var(--primary); text-shadow: 0 0 16px rgba(0,255,208,0.95), 0 0 42px rgba(0,255,208,0.5); }

    .panel { position: relative; z-index: 1; max-width: 1100px; margin: 0 auto 36px; padding: 16px; }
    .card { background: var(--card); border: 1px solid var(--card-border); border-radius: 16px; backdrop-filter: blur(10px); box-shadow: 0 0 0 1px rgba(0,255,208,0.2), 0 20px 60px rgba(0,0,0,0.45), inset 0 0 50px rgba(0,255,208,0.08); }

    .layout { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px; }
    @media (max-width: 980px) { .layout { grid-template-columns: 1fr; } }

    .toolbar { display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: center; padding: 12px; }

    .input { position: relative; }
    .input input {
      width: 100%; padding: 12px 14px 12px 44px; border-radius: 12px; border: 1px solid var(--card-border);
      background: rgba(0,0,0,0.35); color: var(--text); outline: none; box-shadow: inset 0 0 0 1px rgba(0,255,208,0.25);
    }
    .input svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: .9; color: var(--primary); }

    .btn { border: 1px solid var(--card-border); background: linear-gradient(180deg, rgba(0,255,208,0.2), rgba(0,255,208,0.08)); color: var(--text); padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 700; letter-spacing: .02em; transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease; box-shadow: 0 0 0 1px rgba(0,255,208,0.45), 0 8px 30px rgba(0,255,208,0.22); }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 8px 26px rgba(102,179,255,0.35), 0 0 0 2px rgba(102,179,255,0.45) inset; }
    .btn:disabled { opacity: .6; cursor: not-allowed; filter: grayscale(.2); }
    .btn.primary { border-color: rgba(102,179,255,0.7); box-shadow: 0 0 0 1px rgba(102,179,255,0.6), 0 8px 30px rgba(102,179,255,0.3); }
    .btn.danger { border-color: rgba(255,107,107,0.6); background: linear-gradient(180deg, rgba(255,107,107,0.2), rgba(255,107,107,0.08)); box-shadow: 0 0 0 1px rgba(255,107,107,0.5), 0 8px 30px rgba(255,107,107,0.25); }

    .chips { grid-column: 1 / -1; display: flex; gap: 8px; flex-wrap: wrap; margin-top: 4px; }
    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: var(--chip-bg); border: 1px solid var(--card-border); box-shadow: 0 0 0 1px rgba(102,179,255,0.25); }
    .chip b { color: var(--text); }
    .chip button { border: none; background: transparent; color: var(--danger); cursor: pointer; font-weight: 900; padding: 0 4px; border-radius: 8px; box-shadow: none; }
    .chip button:hover { filter: drop-shadow(0 0 6px rgba(255,107,107,0.6)); }

    .stage { padding: 16px; }
    .stage-inner { display: grid; grid-template-rows: auto auto 1fr auto; gap: 12px; }
    .canvas-wrap { position: relative; border-radius: 16px; overflow: hidden; padding: 14px; background: radial-gradient(600px 300px at 20% 20%, rgba(0,255,208,0.12), transparent 60%); border: 1px solid rgba(0,255,208,0.35); box-shadow: 0 0 0 1px rgba(0,255,208,0.35), inset 0 0 40px rgba(0,255,208,0.12); }
    canvas { display: block; width: 100%; height: auto; border-radius: 12px; background: radial-gradient(800px 600px at 85% 20%, rgba(102,179,255,0.12), transparent 60%), radial-gradient(800px 600px at 15% 80%, rgba(255,102,245,0.12), transparent 60%), #0e1326; outline: 1px solid rgba(255,255,255,0.08); box-shadow: inset 0 0 80px rgba(0,0,0,0.6); }

    .result { text-align: center; font-size: 18px; color: var(--muted); }
    .result .name { color: var(--primary); font-size: 22px; font-weight: 900; text-shadow: 0 0 14px rgba(0,255,208,0.8); }

    .list { padding: 16px; height: 100%; display: grid; grid-template-rows: auto 1fr; gap: 10px; }
    .list h3 { margin: 6px 6px 0; font-weight: 800; letter-spacing: .02em; color: var(--muted); }
    .scroll { border: 1px solid var(--card-border); background: rgba(0,0,0,0.35); border-radius: 14px; overflow: hidden; height: 100%; box-shadow: inset 0 0 0 1px rgba(102,179,255,0.2); }
    ul { list-style: none; padding: 6px 8px; margin: 0; max-height: 520px; overflow-y: auto; }
    li { padding: 10px 12px; border-bottom: 1px dashed rgba(255,255,255,0.12); display: flex; align-items: center; gap: 8px; }
    li::before { content: "●"; color: var(--primary-2); font-size: 10px; text-shadow: 0 0 10px rgba(102,179,255,0.9); }
    .badge { margin-left: auto; font-size: 12px; color: var(--primary); opacity: .9; }
  </style>
</head>
<body>
  <div class="grid-overlay"></div>
  <header>
    <div class="brand">抽籤開始，<span class="glow">祝你好運</span></div>
  </header>

  <section class="panel">
    <div class="card toolbar">
      <div class="input">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-opacity="0.9" stroke-width="1.6" stroke-linecap="round"/></svg>
        <input id="name-input" type="text" placeholder="輸入名字後按 Enter 新增至名單（可刪除）" autofocus />
      </div>
      <button id="draw-btn" class="btn primary" disabled>開始抽籤</button>
      <button id="share-btn" class="btn" disabled>分享抽籤</button>
      <div id="chip-list" class="chips"></div>
    </div>
  </section>

  <section class="panel card">
    <div class="layout">
      <div class="stage">
        <div class="stage-inner">
          <div class="canvas-wrap">
            <canvas id="lotteryCanvas" width="700" height="560"></canvas>
          </div>
          <div class="result">目前狀態：<span id="result-box">請先輸入名字</span>
            <span class="name" id="result-name"></span>
          </div>
        </div>
      </div>
      <aside class="list">
        <h3>中籤名單</h3>
        <div class="scroll">
          <ul id="history-list"></ul>
        </div>
      </aside>
    </div>
  </section>

  <script>
    let names = [];
    const canvas = document.getElementById('lotteryCanvas');
    const ctx = canvas.getContext('2d');
    const drawBtn = document.getElementById('draw-btn');
    const shareBtn = document.getElementById('share-btn');
    const resultBox = document.getElementById('result-box');
    const resultName = document.getElementById('result-name');
    const historyList = document.getElementById('history-list');
    const nameInput = document.getElementById('name-input');
    const chipList = document.getElementById('chip-list');

    let cols = 1, rows = 1, cellW, cellH;
    let removedIndices = new Set();
    let rollingInterval = null; // 全域唯一的 rollingInterval
    let finalIndex = -1;        // 全域唯一的 finalIndex

    function renderChips() {
      chipList.innerHTML = '';
      names.forEach((n, idx) => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `<b>${n}</b> <button title="刪除" data-idx="${idx}">×</button>`;
        chipList.appendChild(chip);
      });
      // 綁定刪除
      chipList.querySelectorAll('button[data-idx]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const i = parseInt(e.currentTarget.getAttribute('data-idx'));
          names.splice(i, 1);
          setupGrid();
          renderChips();
        });
      });
    }

    // 高亮框
    function highlightCell(x, y, w, h) {
      ctx.save();
      const g = ctx.createLinearGradient(x, y, x+w, y+h);
      g.addColorStop(0, 'rgba(0,255,208,0.95)');
      g.addColorStop(1, 'rgba(102,179,255,0.95)');
      ctx.strokeStyle = g; ctx.lineWidth = 3; ctx.shadowColor = 'rgba(0,255,208,0.85)'; ctx.shadowBlur = 22; ctx.strokeRect(x+2, y+2, w-4, h-4);
      ctx.restore();
    }

    function setupGrid() {
      cols = Math.max(1, Math.ceil(Math.sqrt(names.length)));
      rows = Math.max(1, Math.ceil(names.length / cols));
      cellW = canvas.width / cols; cellH = canvas.height / rows;
      removedIndices.clear();
      drawGrid();
      drawBtn.disabled = names.length === 0;
      shareBtn.disabled = true;
      resultBox.textContent = names.length ? '按「開始抽籤」' : '請先輸入名字';
      resultName.textContent = '';
    }

    function getAvailableIndices() { return names.map((_, i) => i).filter(i => !removedIndices.has(i)); }

    function drawGrid(highlightIndex = -1) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      names.forEach((name, i) => {
        const col = i % cols; const row = Math.floor(i / cols);
        const x = col * cellW; const y = row * cellH;
        const played = removedIndices.has(i);
        const bgGrad = ctx.createLinearGradient(x, y, x + cellW, y + cellH);
        if (played) { bgGrad.addColorStop(0, 'rgba(255,255,255,0.05)'); bgGrad.addColorStop(1, 'rgba(255,255,255,0.03)'); }
        else { bgGrad.addColorStop(0, 'rgba(102,179,255,0.2)'); bgGrad.addColorStop(1, 'rgba(0,255,208,0.2)'); }
        ctx.fillStyle = bgGrad; ctx.fillRect(x, y, cellW, cellH);
        ctx.strokeStyle = 'rgba(255,255,255,0.14)'; ctx.lineWidth = 1; ctx.strokeRect(x, y, cellW, cellH);
        ctx.fillStyle = played ? 'rgba(255,255,255,0.5)' : 'rgba(255,255,255,0.95)';
        ctx.font = '800 16px system-ui, -apple-system, Segoe UI, Roboto, PingFang TC, Noto Sans TC, Arial';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(name, x + cellW/2, y + cellH/2);
        if (i === highlightIndex) highlightCell(x, y, cellW, cellH);
      });
    }

    // Web Audio 嗶聲
    let audioCtx;
    function playBeep(freq = 1250, ms = 60, gain = 0.035) {
      try {
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = 'square'; o.frequency.value = freq; g.gain.value = gain; o.connect(g); g.connect(audioCtx.destination);
        o.start(); setTimeout(() => { o.stop(); }, ms);
      } catch (e) {}
    }

    // Enter 新增 / Backspace 快速刪除最後一筆
    nameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const name = nameInput.value.trim();
        if (!name) return;
        names.push(name);
        nameInput.value = '';
        setupGrid();
        renderChips();
        playBeep(900, 80, 0.03);
      }
      if (e.key === 'Backspace' && !nameInput.value) {
        names.pop();
        setupGrid();
        renderChips();
        playBeep(650, 60, 0.03);
      }
    });

    // 抽籤流程（不重複）
    drawBtn.addEventListener('click', () => {
      const available = getAvailableIndices();
      if (!available.length) { resultBox.textContent = '所有人已抽完'; drawBtn.disabled = true; return; }
      drawBtn.disabled = true; shareBtn.disabled = true; resultBox.textContent = '抽籤中…'; resultName.textContent = '';
      let currentIndex = -1; const duration = 2000 + Math.random() * 2000; const stepMs = 100;
      // 使用全域 rollingInterval，不再重新宣告
      rollingInterval = setInterval(() => {
        const avail = getAvailableIndices(); currentIndex = avail[Math.floor(Math.random() * avail.length)];
        drawGrid(currentIndex); playBeep(1300, 40, 0.03);
      }, stepMs);
      setTimeout(() => {
        clearInterval(rollingInterval);
        finalIndex = currentIndex; removedIndices.add(finalIndex);
        drawGrid(finalIndex); resultBox.textContent = '中籤者：'; resultName.textContent = names[finalIndex];
        playBeep(900, 80, 0.035); setTimeout(() => playBeep(1500, 100, 0.04), 90);
        const li = document.createElement('li'); li.innerHTML = `<span>${names[finalIndex]}</span><span class="badge">✓</span>`; historyList.appendChild(li);
        drawBtn.disabled = false; shareBtn.disabled = false;
      }, duration);
    });

    // 分享
    shareBtn.addEventListener('click', () => {
      if (finalIndex < 0) { alert('請先完成一次抽籤'); return; }
      const text = `抽籤結果\n中籤者：${names[finalIndex]}`;
      if (navigator.share) navigator.share({ title: '抽籤結果', text });
      else navigator.clipboard.writeText(text).then(() => alert('結果已複製到剪貼簿'));
    });

    // ===== 開發用小測試（顯示於 Console） =====
    function selfTest() {
      console.group('[自動化測試]');
      console.assert(typeof rollingInterval !== 'undefined', 'rollingInterval 應已在全域宣告');
      console.assert(typeof drawGrid === 'function', 'drawGrid 應為函式');
      console.assert(typeof setupGrid === 'function', 'setupGrid 應為函式');
      // 模擬加入名字
      const len0 = names.length; names.push('TestUser'); setupGrid();
      console.assert(names.length === len0 + 1, '加入名字應使名單+1');
      // 撤回
      names.pop(); setupGrid();
      console.assert(names.length === len0, '刪除最後一名應回復原長度');
      console.groupEnd();
    }
    window.__selfTest = selfTest;

    // 初始
    renderChips();
    drawGrid();
    // 自動執行一次簡單檢查
    selfTest();
  </script>
</body>
</html>
